<ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()" (willPresent)="onModalWillPresent()">
  <ng-template>
    <div class="min-h-screen bg-black/50 dark:bg-black/70 flex items-center justify-center p-4 overflow-y-auto">
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-md mx-auto my-4 overflow-hidden transform transition-all duration-300 scale-95 animate-in fade-in-90 zoom-in-90 max-h-[calc(100vh-2rem)]">

        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 p-6">
          <h3 class="text-xl font-bold text-white flex items-center gap-3">
            <ion-icon name="book" class="text-2xl"></ion-icon>
            Add Homework
          </h3>
        </div>

        <!-- Modal Form -->
        <div class="p-6 overflow-y-auto max-h-[calc(100vh-12rem)]">
          <form [formGroup]="modalForm" (ngSubmit)="saveHomework()" class="space-y-4">

            <!-- Title Field -->
            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">Title</label>
              <ion-input
                type="text"
                formControlName="title"
                placeholder="Enter homework title"
                class="custom-input w-full p-3 rounded-xl bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                required>
              </ion-input>
              @if (modalForm.get('title')?.invalid && modalForm.get('title')?.touched) {
                <div class="text-red-500 text-xs font-medium mt-1">
                  Title is required (minimum 3 characters)
                </div>
              }
            </div>

            <!-- Description Field -->
            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">Description</label>
              <ion-textarea
                formControlName="description"
                placeholder="Enter homework description"
                class="custom-input w-full p-3 rounded-xl bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                rows="3"
                [class.border-red-300]="modalForm.get('description')?.invalid && modalForm.get('description')?.touched"
                [class.focus:ring-red-500]="modalForm.get('description')?.invalid && modalForm.get('description')?.touched"
                required>
              </ion-textarea>
              @if (modalForm.get('description')?.invalid && modalForm.get('description')?.touched) {
                <div class="text-red-500 text-xs font-medium mt-1">
                  Description is required
                </div>
              }
            </div>

            <!-- Due Date Field -->
            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">Due Date</label>
              @if (showDateTime) {
                <ion-datetime
                  presentation="date-time"
                  formControlName="dueDate"
                  class="w-full rounded-xl bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                  [class.border-red-300]="modalForm.get('dueDate')?.invalid && modalForm.get('dueDate')?.touched"
                  [showDefaultTitle]="false"
                  [showDefaultButtons]="false"  [min]="today">
                </ion-datetime>
              }
              @if (modalForm.get('dueDate')?.invalid && modalForm.get('dueDate')?.touched) {
                <div class="text-red-500 text-xs font-medium mt-1">
                  Please select a due date
                </div>
              }
            </div>

            <!-- Class Selection Field -->
            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">Select Class</label>
              <ion-select
                placeholder="Choose class"
                formControlName="className"
                class="custom-input w-full rounded-xl bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                interface="action-sheet"
                [class.border-red-300]="modalForm.get('className')?.invalid && modalForm.get('className')?.touched">
                @for (cls of classes; track cls.id) {
                  <ion-select-option [value]="cls.id">{{ cls.name }}</ion-select-option>
                }
              </ion-select>
              @if (modalForm.get('className')?.invalid && modalForm.get('className')?.touched) {
                <div class="text-red-500 text-xs font-medium mt-1">
                  Please select a class
                </div>
              }
            </div>

            <!-- Status Field -->
            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-2">Status</label>
              <ion-select
                placeholder="Choose status"
                formControlName="status"
                class="custom-input w-full rounded-xl bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                interface="action-sheet">
                <ion-select-option value="pending">Pending</ion-select-option>
                <ion-select-option value="completed">Completed</ion-select-option>
              </ion-select>
            </div>

            <!-- Modal Buttons -->
            <div class="flex gap-3 pt-4">
              <button
                type="submit"
                [disabled]="!modalForm.valid || isLoading"
                class="flex-1 bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2 transform hover:scale-[1.02] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:transform-none">

                @if (!isLoading) {
                  <div class="flex items-center justify-center gap-2">
                    <ion-icon name="checkmark" class="text-lg"></ion-icon>
                    Save
                  </div>
                }

                @if (isLoading) {
                  <div class="flex items-center justify-center gap-2">
                  <!-- Loading Spinner -->
                  <div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                  <span>Saving...</span>
                  </div>
                }
              </button>

              <button
                type="button"
                (click)="closeModal()"
                class="flex-1 bg-gradient-to-r from-gray-300 to-gray-400 dark:from-slate-600 dark:to-slate-700 text-gray-800 dark:text-white font-bold py-3 px-6 rounded-xl shadow hover:shadow-md transition-all duration-200 flex items-center justify-center gap-2 transform hover:scale-[1.02] active:scale-95">
                <ion-icon name="close-circle" class="text-lg"></ion-icon>
                Cancel
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>
  </ng-template>
</ion-modal>
